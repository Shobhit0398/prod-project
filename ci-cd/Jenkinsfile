pipeline {
    agent any

    environment {
        AZURE_SUBSCRIPTION_ID = "5d1ae6c1-19d8-4079-a2dd-0e92429e3a29"
        AZURE_TENANT_ID       = credentials('azure-tenant-id')
        AZURE_CLIENT_ID       = credentials('azure-client-id')
        AZURE_CLIENT_SECRET   = credentials('azure-client-secret')

        ACR_NAME   = "myprodacr3"
        ACR_LOGIN  = "myprodacr3.azurecr.io"
        IMAGE_NAME = "myapp"
        IMAGE_TAG  = "${GIT_COMMIT.take(7)}"

        HELM_VALUES_FILE = "helm/myapp/values.yaml"
        GIT_BRANCH = "main"
    }

    stages {

        stage('Azure Login') {
            steps {
                sh '''
                az login --service-principal \
                  -u $AZURE_CLIENT_ID \
                  -p $AZURE_CLIENT_SECRET \
                  --tenant $AZURE_TENANT_ID

                az account set --subscription $AZURE_SUBSCRIPTION_ID
                '''
            }
        }

        stage('Login to ACR') {
            steps {
                sh '''
                az acr login --name $ACR_NAME
                '''
            }
        }

        stage('Build Docker Image') {
            steps {
                sh '''
                docker build \
                  -t $ACR_LOGIN/$IMAGE_NAME:$IMAGE_TAG -f app/Dockerfile \
                  ./app
                '''
            }
        }

        stage('Push Image to ACR') {
            steps {
                sh '''
                docker push $ACR_LOGIN/$IMAGE_NAME:$IMAGE_TAG
                '''
            }
        }

        stage('Update Helm Values (GitOps)') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'github',
                    usernameVariable: 'GIT_USER',
                    passwordVariable: 'GIT_TOKEN'
                )]) {
            // 1. Commit Stage (No Change needed here)
                    sh '''
                    sed -i "s/tag:.*/tag: \\"${IMAGE_TAG}\\"/" ${HELM_VALUES_FILE}

                    git config user.email "shobhitnagar71@gmail.com" // Use a generic CI email
                    git config user.name "Shobhit0398" // Use a generic CI name
    
                    git add ${HELM_VALUES_FILE}
                    git commit -m "Release: ${IMAGE_TAG}"
                    '''
            
            // 2. Push Stage (Using a dedicated script block for robust variable handling)
                    script {
                // DEBUG: Print the user variable to confirm it's available in the script context.
                        echo "DEBUG: GIT_USER is defined as: ${GIT_USER}"
                
                // CRITICAL FIX: The entire push command is built as one Groovy string 
                // and executed in a dedicated SH step.
                        def remoteUrl = "https://${GIT_USER}:${GIT_TOKEN}@github.com/Shobhit0398/prod-project.git"
                
                        sh """
                # Print the command Git will execute (with token masked)
                        echo "Executing push to: ${remoteUrl.replace(GIT_TOKEN, '****')}"
                
                # Execute the push command
                        git push ${remoteUrl} HEAD:${GIT_BRANCH}
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "✅ Pipeline completed successfully. ArgoCD will deploy automatically."
        }
        failure {
            echo "❌ Pipeline failed. Check logs."
        }
    }
}
